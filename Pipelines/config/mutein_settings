## this script is sourced by the user to setup their working environment
## ============ ONLY EDIT THIS SECTION ============

#the Mutein repository folder
export MUT_DIR=~/repos/Mutein

#the Mutein data folder
export MUT_DATA=~/549_mutein

## ================================================

## the following will not normally need to be edited by the user

#add Mutein scripts to the path
export PATH=${MUT_DIR}/Pipelines/scripts:${PATH}

#add Mutein python modules to PYTHONPATH
export PYTHONPATH=${MUT_DIR}/Pipelines/varcall_modules:${PYTHONPATH}

#set the snakemake profile folder and path to snakefile and mutein config
export SNAKEMAKE_PROFILE=${MUT_DIR}/Pipelines/config
export SNAKEFILE=${MUT_DIR}/Pipelines/config/Snakefile
export SNAKECONF=${MUT_DIR}/Pipelines/config/mutein.yaml

#always pass the snakefile and configfile to snakemake
alias snakemake="snakemake --snakefile ${SNAKEFILE} --configfile ${SNAKECONF}"

#conda environment names prefix to reduce chances of namespace collisions
export MUT_PREFIX=mutein_

## ========== END OF CONFIG =======================

# note: this file will be sourced into an interactive shell
# therefore it's not appropriate to use "set -eu"

# setup conda snakemake environment if not already available (also provides python3)
result=$( conda env list | grep -e "${MUT_PREFIX}main" | wc --lines )
if [ "${result}" == "0" ] ; then
    echo "Setting up the main conda environment..."
    conda create -y -n ${MUT_PREFIX}main \
        $(cat ${MUT_DIR}/Pipelines/conda_envs/channels) \
        --file ${MUT_DIR}/Pipelines/conda_envs/main.env \
    || { echo "Failed to setup snakemake conda environment!"; exit 1; }
fi

# activate snakemake conda environment, also provides python3
echo "Activating the conda snakemake environment..."
conda activate ${MUT_PREFIX}main \
|| { echo "Failed to activate snakemake conda environment!"; exit 1; }

# verify mutein is in the PATH and print warning if not in MUT_DATA directory
mutein check-cwd \
|| { echo "Failed to run mutein script!"; exit 1; }

# set the master password used to decrypt specific passwords from encrypted file
export MUT_PASSWORD=$(mutein get-password)