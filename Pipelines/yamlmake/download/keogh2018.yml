#define dataset_id and subset_list
- config:
    dataset_id: "keogh2018"

    #currently only one data subset within keogh2018
    subset_id:
      - "SRP159015"

#download list of accession names
- action:
    name:  "download_accession_list"
    exec:  "local"
    conda: "enabrowsertools"

    input:
        keogh_config: "{%conf_dir}/download/keogh2018_config.yml"

    output:
        accession_file: "datasets/{%dataset_id}/{=subset_id}/.meta/accession_list"

    #grab list of sra run accessions from NCBI (US site)
    shell: |
        esearch -db sra -query {=subset_id} \
        | efetch -format xml \
        | xtract -pattern RUN -element PRIMARY_ID \
        | awk '{{print $1}}' \
        | sort \
        > {%accession_file}

- action:
    name: "create_accession_folders"
    exec:  "local"

    input:
        #spawn one job per subset_id, currently there's only one
        accession_list: "datasets/{%dataset_id}/{=subset_id}/.meta/accession_list"

    output:
        touch: "datasets/{%dataset_id}/{=subset_id}/.meta/created_folders.touch"

    shell: |
        for acc in $(cat {%accession_list})
        do
            mkdir -p datasets/{%dataset_id}/{=subset_id}/${acc}
        done
        touch {%touch}

- action:
    name: "download_accessions"
    exec:  "local"
    conda: "enabrowsertools"

    input:
        #spawn one job per subset x accession
        accession_dir: "datasets/{%dataset_id}/{=subset_id}/{*accession}"

    output:
        read1: "datasets/{%dataset_id}/{=subset_id}/{*accession}/{*accession}_1.fastq.gz"
        read2: "datasets/{%dataset_id}/{=subset_id}/{*accession}/{*accession}_2.fastq.gz"

    shell: |
        cd {%accession_dir}
        enaDataGet -f fastq {*accession}
