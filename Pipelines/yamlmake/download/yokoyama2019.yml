#define dataset_id and subset_list
- config:
    dataset_id: "yokoyama2019"

    subset_id:
      - "EGAD00001004464"
      - "EGAD00001004462"
      - "EGAD00010001631"

    credentials: "config/private_config1.json"

#download list of accession names
- action:
    name:  "download_accession_list"
    exec:  "local"
    conda: "pyega3"

    #no input

    output:
        stdout:    "datasets/{%dataset_id}/{=subset_id}/.meta/pyega3.stdout"
        stderr:    "datasets/{%dataset_id}/{=subset_id}/.meta/pyega3.stderr"
        file_list: "datasets/{%dataset_id}/{=subset_id}/.meta/file_list"
        md5_list:  "datasets/{%dataset_id}/{=subset_id}/.meta/md5_list"

    #get list of EGAF accessions and MD5s using pyega3
    shell: |
        pyega3 -cf {%credentials} files {=subset_id}    > {%stdout} 2> {%stderr}
        rm -f pyega3_output.log
        cat {%stderr} | grep EGAF | awk '{print $4}'    > {%file_list}
        cat {%stderr} | grep EGAF | awk '{print $4,$7}' > {%md5_list}

- action:
    name: "create_subset_folders"
    exec: "local"

    input:
        accession_list: "datasets/{%dataset_id}/{=subset_id}/.meta/file_list"

    output:
        touch: "datasets/{%dataset_id}/{=subset_id}/.meta/create_subset_folders.touch"

    shell: |
        for acc in $(cat {%accession_list})
        do
            mkdir -p datasets/{%dataset_id}/{=subset_id}/${acc}
        done
        touch {%touch}

# - action:
#     name: "download_accessions"
#     exec:  "local"
#     conda: "pyega3"

#     input:
#         #spawn one job per subset x accession
#         accession_dir: "datasets/{%dataset_id}/{=subset_id}/{*accession}.d"

#     output:
#         read1: "datasets/{%dataset_id}/{=subset_id}/{*accession}.d/{*accession}_1.fastq.gz"
#         read2: "datasets/{%dataset_id}/{=subset_id}/{*accession}.d/{*accession}_2.fastq.gz"

#     shell: |
#         cd {%accession_dir}
#         enaDataGet -f fastq {*accession}

# the below is being ported to yamlmake from raw script 

# conda activate ${MUT_PREFIX}pyega3

# EGAD00001004464
# EGAD00001004462
# EGAD00010001631

# mkdir -p "${DATA_DIR}"
# cd "${DATA_DIR}"

# for x in $(cat "${ACC_FILE}")
# do
#     mkdir -p ${x} && cd ${x}
#     pyega3 -ms 100000000000 fetch ${x}
#     cd ..
# done \
# > download-${TIMESTAMP}.stdout \
# 2> download-${TIMESTAMP}.stderr


