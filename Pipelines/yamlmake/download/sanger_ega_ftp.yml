#this version uses the ftp download account setup by the ega helpdesk for me
#due to pyega3 not working

#define dataset_id, subset_list, credentials
- include: "../config/sanger_ega_ftp_{$MUT_PLATFORM}.yml"

#recursive ftp download of each accession with ncftp
- action:
    name:  "download_accessions"
    exec:  "local"
    conda: "ncftp"

    #no input

    output:
        touch: "datasets/{%dataset_id}/{=subset_id}/.meta/{%name}.touch"

    shell: |
        ncftpget -f {%credentials} -RT datasets/{%dataset_id} {=subset_id}
        touch {%touch}

#test md5 of all ftp downloaded files
- action:
    name: "verify_ftp_downloads"
    exec: "qsub"
    qsub:
      time:  "1:00:00"
      mem:   "4G"
      cores: "1"

    input:
        #             eg datasets/sanger_ega_ftp/EGAD00001001123/13726_1.cram.cip
        accession_file: "datasets/{%dataset_id}/{=subset_id}/{*accession}.cip"

    output:
        touch: "datasets/{%dataset_id}/{=subset_id}/.meta/{%name}.{*accession}.touch"

    shell: |
        md5_file="{%accession_file}.md5"
        expected=$(cat "${md5_file}")
        observed=$(cat "{%accession_file}" | md5sum | awk '{print $1}')
        [[ "${expected}" == "${observed}" ]] && touch {%touch}

# decrypt files
