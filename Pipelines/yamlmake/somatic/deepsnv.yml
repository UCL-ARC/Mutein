- action:
    name:  "deepsnv"
    exec:  "qsub"
    conda: "bioconductor"

    qsub:
        time:  "1:00:00"
        mem:   "3G"
        cores: "1"

    # filter VCFs from both mutect2 and varscan
    file_prefixes:
        - "_somatic_varscan.snp"
        - "_somatic_mutect2_annotated_filtered"

    input:
        vcf: "processed/{%dataset_id}/{=subset_id}/{*accession}/{*accession}_{*normal}{=file_prefixes}.vcf.gz"
        tbam: "processed/{%dataset_id}/{=subset_id}/{*accession}/{*accession}_bqsr.bam.vcf.gz"
        nbam: "processed/{%dataset_id}/{=subset_id}/{*normal}/{*normal}_bqsr.bam.vcf.gz"
 
    output:
        regions_of_interest: "processed/{%dataset_id}/{=subset_id}/{*accession}/{*accession}_{*normal}{=file_prefixes}_regions_of_interest.tsv"
        deepsnv_output: "processed/{%dataset_id}/{=subset_id}/{*accession}/{*accession}_{*normal}{=file_prefixes}_deepsnv_annotations.tsv"
        deepsnv_vcf: "processed/{%dataset_id}/{=subset_id}/{*accession}/{*accession}_{*normal}{=file_prefixes}_deepsnv_annotated.cvf.gz"

    shell: |
      # spit out the positions from the VCFs that we wish to verify
      bcftools query -f '%CHROM\t%POS\t%ID\t%REF\t%ALT\n' {%vcf} > {%regions_of_interest}
      # Run deepsnv on these positions
      Rscript deepsnv.R {%tbam} {%nbam} {%regions_of_interest} > {%deepsnv_output}

      bgzip -f {%deepsnv_output}
      bcftools index -f --tbi {%deepsnv_output}

      # Add deepsnv scores to a new, annotated VCF
      bcftools annotate \
        -a {%deepsnv_output} \
        --columns CHROM,POS,FILTER
        -Oz -o {%deepsnv_vcf} \
        {%vcf}