#define dataset_id and subset_list
- include: "../config/keogh2018.yml"

#https://gatk.broadinstitute.org/hc/en-us/articles/360037225632-HaplotypeCaller
#use -L to specify target regions, eg for exome/bait capture
#https://gatk.broadinstitute.org/hc/en-us/articles/360035531852-Intervals-and-interval-lists
- action:
    name:  "haplotype_caller"
    exec:  "qsub"
    conda: "gatk4"

    qsub:
      time:  "3:00:00"
      mem:   "9G"
      tmpfs: "1G"
      cores: "4"

    input:
      bam: "datasets/{%dataset_id}/{*subset_id}/{*accession}/{*accession}_aln_sort.bam"

    output:
      vcf: "datasets/{%dataset_id}/{*subset_id}/{*accession}/{*accession}_haplo.vcf"

    #not sure if \"-Xmx8g\" or "-Xmx8g" will work
    shell: |
        gatk --java-options \"-Xmx8g\" HaplotypeCaller \
          --native-pair-hmm-threads {%qsub/cores} -L {%intervals} -ip 10 \
          -R {%ref/fasta_bgz} -I {%bam} -O {%vcf} -ERC GVCF

- action:
    # https://gatk.broadinstitute.org/hc/en-us/articles/360035889971
    name:  "genomics_db_import"
    exec:  "local"
    conda: "gatk4"

    qsub:
      time:  "3:00:00"
      mem:   "9G"
      tmpfs: "1G"
      cores: "4"

    input:
      vcf: "datasets/{%dataset_id}/{*subset_id}/{+accession}/{+accession}_haplo.vcf"

    output:
      gdb:  "datasets/{%dataset_id}/{*subset_id}/.meta/gatk_db"

    shell: |
      rm -rf {%gdb}
      gatk GenomicsDBImport \
        -V {%vcf/ -V } \
        --genomicsdb-workspace-path {%gdb} \
        -L {%intervals} \
        -ip 10

- action:
    name:  "genotype_gvcfs"
    exec:  "qsub"
    conda: "gatk4"

    qsub:
      time:  "3:00:00"
      mem:   "9G"
      tmpfs: "1G"
      cores: "4"

    input:
      gdb:  "datasets/{%dataset_id}/{*subset_id}/.meta/gatk_db"

    output:
      ovcf: "datasets/{%dataset_id}/{*subset_id}/{%dataset_id}_{*subset_id}.vcf"

    shell: |
        gatk GenotypeGVCFs -R {%ref/fasta_bgz} -V gendb://{%gdb} -O {%ovcf}
