#define dataset_id and subset_list
- include: "../config/keogh2018.yml"

#create a new directory hierachy to contain the processed versions of the data
#with symlinks to the originals
- action:
    name: "create_processed_directories"
    exec: "local"

    input:
        original: "datasets/{%dataset_id}/{*subset_id}/{*accession}/{*basename}.fastq.gz"

    output:
        symlink: "processed/{%dataset_id}/{*subset_id}/{*accession}/{*basename}.fastq.gz"

    shell: |
       cd processed/{%dataset_id}/{*subset_id}/{*accession}
       ln -s ../../../../{%original}

#generate QC stats for the "raw" reads
- action:
    name: "fastqc"
    exec: "qsub"
    conda: "trim-galore"

    qsub:
      time:  "1:00:0"
      mem:   "1G"
      tmpfs: "15G"
      cores: "4"

    input:
      fastq: "processed/{%dataset_id}/{*subset_id}/{*accession}/{*file}.fastq.gz"

    output:
      zip:  "processed/{%dataset_id}/{*subset_id}/{*accession}/{*file}_fastqc.zip"
      html: "processed/{%dataset_id}/{*subset_id}/{*accession}/{*file}_fastqc.html"

    shell: |
        fastqc -t {%qsub/cores} {%fastq}

#trim reads with trim_galore
#this is to test trim_galore as the "raw" reads are infact already trimmed!
- action:
    name:  "trim_pair_reads"
    exec:  "local"
    conda: "trim-galore"

    qsub: 
        time:  "24:00:00"
        mem:   "10G"
        tmpfs: "20G"
        cores: "6"

    #testing on random subset of samples to conserve disk space
    test_acc:
        - SRR7762385
        # - SRR7762457
        # - SRR7762519
        # - SRR7762489
        # - SRR7762373
        # - SRR7762421
        # - SRR7762408
        # - SRR7762534
        # - SRR7762485
        # - SRR7762465

    input:
        iread1: "processed/{%dataset_id}/{*subset_id}/{=test_acc}/{=test_acc}_1.fastq.gz"
        iread2: "processed/{%dataset_id}/{*subset_id}/{=test_acc}/{=test_acc}_2.fastq.gz"
        ireadu: "processed/{%dataset_id}/{*subset_id}/{=test_acc}/{=test_acc}.fastq.gz"

    output:
        oread1: "processed/{%dataset_id}/{*subset_id}/{=test_acc}/{=test_acc}_trim_1.fastq.gz"
        oread2: "processed/{%dataset_id}/{*subset_id}/{=test_acc}/{=test_acc}_trim_2.fastq.gz"
        oreadu: "processed/{%dataset_id}/{*subset_id}/{=test_acc}/{=test_acc}_trim.fastq.gz"

    shell: |
        #trim paired reads
        trim_galore --paired {%iread1} {%iread2} \
          --illumina --phred33 -q 20 --stringency 1 \
          -e 0.1 --gzip --length 20 --retain_unpaired \
          --output_dir processed/{%dataset_id}/{*subset_id}/{=test_acc} \
          --cores 2 --three_prime_clip_R1 3 --three_prime_clip_R2 3

        #trim unpaired reads
        trim_galore {%ireadu} \
          --illumina --phred33 -q 20 --stringency 1 \
          -e 0.1 --gzip --length 20 \
          --output_dir processed/{%dataset_id}/{*subset_id}/{=test_acc} \
          --cores 2 --three_prime_clip_R1 3 --three_prime_clip_R2 3

        mv processed/{%dataset_id}/{*subset_id}/{=test_acc}/{=test_acc}_1_val_1.fq.gz {%oread1}
        mv processed/{%dataset_id}/{*subset_id}/{=test_acc}/{=test_acc}_2_val_2.fq.gz {%oread2}

        if [[ -f SRR7762385_1_unpaired_1.fq.gz
        cat 
