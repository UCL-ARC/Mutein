#define dataset_id and subset_list
- include: "../config/keogh2018.yml"

#map paired reads to reference with bwa, add ID tag, sort, output to bam
- action:
    name:  "bwa_mem_pair"
    exec:  "qsub"
    conda: "bwa"

    qsub: 
        time:  "24:00:00" #run time seems to depend on network traffic
        mem:   "10G"
        tmpfs: "20G"
        cores: "2"

    input:
        read1: "processed/{%dataset_id}/{*subset_id}/{*accession}/{*accession}_1.fastq.gz"
        read2: "processed/{%dataset_id}/{*subset_id}/{*accession}/{*accession}_2.fastq.gz"

    output:
        bam:   "processed/{%dataset_id}/{*subset_id}/{*accession}/{*accession}_pair_sort.bam"

    #map with bwa mem, add readgroup tag to say "these are all from the same sample"
    #sort mapped reads by mapping position, output to bam file
    shell: |
        SAMTOOLS_TMP=${TMPDIR}/${USER}-${RANDOM}${RANDOM}
        mkdir -p ${SAMTOOLS_TMP}

        bwa mem -t {%qsub/cores} {%ref/fasta_bgz} {%read1} {%read2} \
        | samtools addreplacerg \
          -r 'ID:{%dataset_id}_{*subset_id}_{*accession}' \
          -r 'SM:{%dataset_id}_{*subset_id}_{*accession}' - \
        | samtools sort -T ${SAMTOOLS_TMP} -O bam -m 2G - \
        > {%bam}

#map single reads to reference with bwa, add ID tag, sort, output to bam
- action:
    name:  "bwa_mem_sing"
    exec:  "qsub"
    conda: "bwa"

    qsub: 
        time:  "24:00:00" #run time seems to depend on network traffic
        mem:   "10G"
        tmpfs: "20G"
        cores: "2"

    input:
        read: "processed/{%dataset_id}/{*subset_id}/{*accession}/{*accession}.fastq.gz"

    output:
        bam:  "processed/{%dataset_id}/{*subset_id}/{*accession}/{*accession}_sing_sort.bam"

    #map with bwa mem, add readgroup tag to say "these are all from the same sample"
    #sort mapped reads by mapping position, output to bam file
    shell: |
        SAMTOOLS_TMP=${TMPDIR}/${USER}-${RANDOM}${RANDOM}
        mkdir -p ${SAMTOOLS_TMP}

        bwa mem -t {%qsub/cores} {%ref/fasta_bgz} {%read} \
        | samtools addreplacerg \
          -r 'ID:{%dataset_id}_{*subset_id}_{*accession}' \
          -r 'SM:{%dataset_id}_{*subset_id}_{*accession}' - \
        | samtools sort -T ${SAMTOOLS_TMP} -O bam -m 2G - \
        > {%bam}
