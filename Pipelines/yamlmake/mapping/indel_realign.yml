#run RealignerTargetCreator from GATK3
#https://web.archive.org/web/20160419061931/https://www.broadinstitute.org/gatk/guide/article?id=1247
#https://github.com/broadinstitute/gatk-docs/blob/master/gatk3-tutorials/(howto)_Perform_local_realignment_around_indels.md
#https://gatk.broadinstitute.org/hc/en-us/articles/360035890811-Resource-bundle
#https://console.cloud.google.com/storage/browser/genomics-public-data/resources/broad/hg38/v0/
#https://sites.google.com/a/broadinstitute.org/legacy-gatk-forum-discussions/2013-06-06-2013-02-12/2362-Best-approach-for-realignertargetcreator-and-indelrealigner
#running all sample through realignertargetcreator at once to create a single intervals files
- action:
    name:  "realigner_target_creator"
    exec:  "qsub"
    conda: "gatk3"

    qsub: 
        time:  "24:00:00"
        mem:   "20G"
        tmpfs: "20G"
        cores: "4"

    input:
        ibam:   "processed/{%dataset_id}/{=subset_id}/{+accession}/{+accession}_posn_sort.bam"
        known1: "{%ref/indels1}"
        known2: "{%ref/indels2}"

    output:
        indels: "processed/{%dataset_id}/{=subset_id}/.meta/realigner_indel.intervals"

    shell: |
        MY_TMP_DIR=${TMPDIR}/${RANDOM}${RANDOM}
        mkdir -p ${MY_TMP_DIR}

        gatk3 \
            -Xmx19G
            -T RealignerTargetCreator \
            --num_threads {%qsub/cores} \
            -R {%ref/uncompressed} \
            -L {%intervals} \
            -I {%ibam/ -I } \
            -known {%known1} -known {%known2} \
            -o {%indels}

#run IndelRealigner from GATK3 so we can use somatic SNP callers that do not do their own
#local denovo assembly / indel realignments