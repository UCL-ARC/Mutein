#https://gatk.broadinstitute.org/hc/en-us/articles/360035890531-Base-Quality-Score-Recalibration-BQSR-
#https://hpc.nih.gov/training/gatk_tutorial/bqsr.html

- action:
    name:  "base_recalibrator"
    exec:  "qsub"
    conda: "gatk4"

    qsub: 
        time:  "24:00:00" 
        mem:   "10G"
        tmpfs: "20G"
        cores: "2"

    input:
        ibam:  "processed/{%dataset_id}/{=subset_id}/{*accession}/{*accession}_posn_sort.bam"

    output:
        bqsr:  "processed/{%dataset_id}/{=subset_id}/{*accession}/{*accession}_posn_sort.bqsr"

    shell: |
        gatk --java-options "-Xmx4G" \
          BaseRecalibrator \
          -I {%ibam} \
          -R {%ref/fasta_bgz} \
          -O {%bqsr} \
          --known-sites {%ref/dbsnp_dir}/{%ref/final_vcf}

# - action:
#     name: "apply_bqsr"
#     shell: |
#         gatk --java-options "-Djava.io.tmpdir=/lscratch/$SLURM_JOBID -Xms2G -Xmx2G -XX:ParallelGCThreads=2"
#         ApplyBQSR \
#           -I NA12878_markdup.bam \
#           -R /fdb/igenomes/Homo_sapiens/UCSC/hg38/Sequence/WholeGenomeFasta/genome.fa \
#           --bqsr-recal-file NA12878_markdup_bqsr.report \
#           -O NA12878_markdup_bqsr.bam